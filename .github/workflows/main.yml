name: CI
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # Job de Infraestrutura 
  infrastructure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.0
      - name: Terraform Init
        run: terraform init
      - name: Terraform Plan
        run: terraform plan
      - name: Terraform Apply
        run: terraform apply -auto-approve
      - name: Verificar arquivo criado
        run: |
          echo "Conteúdo do arquivo de configuração:"
          cat app_config.txt
      - name: Upload arquivo de configuração
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-artifacts
          path: app_config.txt
          retention-days: 7

  # Job de Build - (Construtução)
  build:
    runs-on: ubuntu-latest
    needs: infrastructure  # Executa após a infraestrutura
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
      - name: Download infrastructure artifacts
        uses: actions/download-artifact@v4
        with:
          name: infrastructure-artifacts
      - name: Verificar configuração da infraestrutura
        run: |
          echo "Configuração da infraestrutura disponível:"
          cat app_config.txt
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
      - name: Instalar dependências
        run: npm install
      - name: Build da aplicação
        run: npm run build
      - name: Upload dos artefatos
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            *.html
            *.js
            *.css
          retention-days: 7

  # Job de Testes Cypress 
  cypress-run:
    runs-on: ubuntu-latest
    needs: build  # Executa após o build
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
      - name: Download infrastructure artifacts
        uses: actions/download-artifact@v4
        with:
          name: infrastructure-artifacts
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      - name: Verificar artefatos disponíveis
        run: |
          echo "Artefatos de infraestrutura:"
          cat app_config.txt
          echo ""
          echo "Artefatos de build:"
          ls -la *.html *.js *.css 2>/dev/null || echo "Nenhum artefato de build encontrado no root"
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Instalar dependências
        run: npm install
      - name: Iniciar servidor
        run: npm run dev &
      - name: Espera o servidor ficar pronto
        run: npx wait-on http://127.0.0.1:8080 --timeout 120000
      - name: Rodar testes Cypress
        run: npx cypress run

  # Job de "Deploy" 
  deploy-local:
    runs-on: ubuntu-latest
    needs: cypress-run
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      - name: Verificar artefatos para deploy
        run: |
          echo "Simulando deploy local..."
          ls -la *.html *.js *.css
          echo "Deploy local simulado concluído com sucesso!"


