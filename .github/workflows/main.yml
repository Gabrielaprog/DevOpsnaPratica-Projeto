name: CI
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
jobs:
  # Job de Infraestrutura 
  infrastructure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.0
      - name: Terraform Init
        run: terraform init
      - name: Terraform Plan
        run: terraform plan
      - name: Terraform Apply
        run: terraform apply -auto-approve
      - name: Verificar arquivo criado
        run: |
          echo "ðŸ“„ ConteÃºdo do arquivo de configuraÃ§Ã£o:"
          cat app_config.txt
      - name: Upload arquivo de configuraÃ§Ã£o
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-artifacts
          path: app_config.txt
          retention-days: 7

  # Job de Build
  build:
    runs-on: ubuntu-latest
    needs: infrastructure  # Executa apÃ³s a infraestrutura
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      - name: Download infrastructure artifacts
        uses: actions/download-artifact@v4
        with:
          name: infrastructure-artifacts
      - name: Verificar configuraÃ§Ã£o da infraestrutura
        run: |
          echo "âœ… ConfiguraÃ§Ã£o da infraestrutura disponÃ­vel:"
          cat app_config.txt
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
      - name: Instalar dependÃªncias
        run: npm install
      - name: Build da aplicaÃ§Ã£o
        run: npm run build
      - name: Upload dos artefatos
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            *.html
            *.js
            *.css
          retention-days: 7

  # Job de Testes Cypress 
  cypress-run:
    runs-on: ubuntu-latest
    needs: build  # Executa apÃ³s o build
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      - name: Download infrastructure artifacts
        uses: actions/download-artifact@v4
        with:
          name: infrastructure-artifacts
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      - name: Verificar artefatos disponÃ­veis
        run: |
          echo "ðŸ“¦ Artefatos de infraestrutura:"
          cat app_config.txt
          echo ""
          echo "ðŸ—ï¸ Artefatos de build:"
          ls -la *.html *.js *.css 2>/dev/null || echo "Nenhum artefato de build encontrado no root"
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Instalar dependÃªncias
        run: npm install
      - name: Iniciar servidor
        run: npm run dev &
      - name: Wait for server to be ready
        run: npx wait-on http://127.0.0.1:8080 --timeout 120000
      - name: Rodar testes Cypress
        run: npx cypress run

